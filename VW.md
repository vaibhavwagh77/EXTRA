LDAP : Light Weight Directory Access Protocol
\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`
LDAP Server : master.spider.com : 192.168.206.100 LDAP Client :
slave.spider.com : 192.168.206.101

DN: spider.com dc=spider dc=com

On LDAP Server: \`\`\`\`\`\`\`\`\`\`\`\`\`\`\` \# setenforce 0

1\) Install \`\`\`\`\`\`\`\`\`\`\` \# yum install -y openldap
openldap-servers openldap-clients openldap-devel migrationtools \# wget
https://fr2.rpmfind.net/linux/fedora/linux/development/rawhide/Everything/x86_64/os/Packages/m/migrationtools-47-35.fc41.noarch.rpm
\# rpm -ivh migration-tar name \# systemctl start slapd \# systemctl
status slapd \# systemctl enable slapd \# lsof -i:389 \[ TCP \]

2\) Setup root/ldap admin user passsword who can manage LDAP
database/config:
\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`
\# echo \"redhat\" \> /tmp/pass \# chmod 400 /tmp/pass

\# slappasswd New password: \*\*\*\*\*\* Re-type password: \*\*\*\*\*\*
{SSHA}yPTjpRb8mwP1AMIy5LB2d+UzOu/MoTWc

NOTE: Copy that password

OR

\# slappasswd -s redhat -n \> /etc/openldap/passwd OR

\# slappasswd -T /tmp/pass \> /etc/openldap/passwd

\# cat /etc/openldap/passwd

3\) Generate cert: \`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\` \# openssl req
-new -x509 -nodes -out /etc/openldap/certs/ditiss.pem -keyout
/etc/openldap/certs/ditiss_key.pem -days 365

\[ Default Days: 30 \]

\# chown ldap:ldap /etc/openldap/certs/\*.pem

4\) Go to configuration dir to prepare LDAP DATABASE:
\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`
cp /usr/share/openldap-servers/DB_CONFIG.example /var/lib/ldap/DB_CONFIG
-fv

chown -R ldap:ldap /var/lib/ldap/\*

ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schema/cosine.ldif
ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schema/nis.ldif
ldapadd -Y EXTERNAL -H ldapi:/// -f
/etc/openldap/schema/inetorgperson.ldif \# cd /etc/openldap/slapd.d/

The main config dir named as \"cn=config\"

\# cd \"cn=config\" \# ls -l

=\> In this dir, you will see files with extension \".ldif\" \[LDAP Data
Interchange Format\]. =\> We need to focus on two files to manage the
LDAP database/config:

a) \"olcDatabase={2}hdb.ldif\" b) \"olcDatabse={1}monitor.ldif\"

5\) Configure: \`\`\`\`\`\`\`\`\`\`\`\`\` Create a file to modify LDAP
database/config using \"ldapmodify\" command:

SYNTAX to change config:
\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\` dn: entryDN changetype:
modify add: attribute attribute: value\... - replace: attribute
attribute: newValue\... - delete: attribute \[attribute: value\] \...

\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\` SYNTAX END

ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schema/cosine.ldif
ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schema/nis.ldif
ldapadd -Y EXTERNAL -H ldapi:/// -f
/etc/openldap/schema/inetorgperson.ldif

\# vim hdb_conf.ldif

dn: olcDatabase={2}hdb,cn=config changetype: modify replace: olcSuffix
olcSuffix: dc=spider,dc=com

dn: olcDatabase={2}hdb,cn=config changetype: modify replace: olcRootDN
olcRootDN: cn=Manager,dc=spider,dc=com

dn: olcDatabase={2}hdb,cn=config changetype: modify replace: olcRootPW
olcRootPW: \<\<\<PASTE THE PASSWORD GENERATED by slappasswd
COMMAND\>\>\>

UPDATE THE CONF: \`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\` \# ldapmodify -Y
EXTERNAL -H ldapi:/// -f hdb_conf.ldif

\# vim monitor_conf.ldif

dn: olcDatabase={1}monitor,cn=config changetype: modify replace:
olcAccess olcAccess: {0}to \* by
dn.base=\"gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth\" read
by dn.base=\"cn=Manager,dc=spider,dc=com\" read by \* none

UPDATE THE CONF: \`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\` \# ldapmodify -Y
EXTERNAL -H ldapi:/// -f monitor_conf.ldif

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_

\# vim cert.ldif

dn: cn=config changetype: modify replace: olcTLSCertificateFile
olcTLSCertificateFile: /etc/openldap/certs/ditiss.pem

dn: cn=config changetype: modify replace: olcTLSCertificateKeyFile
olcTLSCertificateKeyFile: /etc/openldap/certs/ditiss_key.pem

UPDATE THE CONF: \`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\` \# ldapmodify -Y
EXTERNAL -H ldapi:/// -f cert.ldif

BASE: \`\`\`\`\`\` \# vim base.ldif

dn: dc=spider,dc=com dc: spider objectClass: top objectClass: domain

dn: cn=Manager,dc=spider,dc=com objectClass: organizationalRole cn:
ldapadm description: LDAP Manager

dn: ou=People,dc=spider,dc=com objectClass: organizationalUnit ou:
People

dn: ou=Group,dc=spider,dc=com objectClass: organizationalUnit ou: Group

UPDATE THE CONF: \`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\` \# ldapadd -x -W
-D \"cn=Manager,dc=spider,dc=com\" -y /tmp/pass -f base.ldif

5\) Test the config file :
\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\` \# slaptest -u

6\) Migrate all the user\'s DB:
\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\` \# cd
/usr/share/migrationtools

\>\>\>\> Add your Domain \# vim migrate_common.ph

\# Default DNS Domain \$DEFAULT_MAIL_DOMAIN = \"padl.com\" \# Default
Base \$DEFAULT_BASE = \"dc=padl,dc=com\" \# such as person.
\$EXTENDED_SCHEMA = 0; \|\| \\/

\$DEFAULT_MAIL_DOMAIN = \"spider.com\" \$DEFAULT_BASE =
\"dc=spider,dc=com\" \$EXTENDED_SCHEMA = 1;

:wq

\[+\] Copy all the regular user\'s & group\'s DB from passwd to
/usr/share/migrationtools
\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`
\# egrep \":\[0-9\]{4,}:\" /etc/passwd \>
/usr/share/migrationtools/passwd \# egrep \":\[0-9\]{4,}:\" /etc/group
\> /usr/share/migrationtools/group

\[+\] Generate LDIF file using \`migrate_passwd.pl\` for passwd and
group:
\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`
Also add export command in \~/.bashrc \# export LC_CTYPE=en_US.UTF-8 \#
export LC_ALL=en_US.UTF-8

\# ./migrate_passwd.pl /usr/share/migrationtools/passwd
/usr/share/migrationtools/users.ldif \# ./migrate_passwd.pl
/usr/share/migrationtools/group /usr/share/migrationtools/groups.ldif

\[+\] Now add \"users.ldif\" & \"groups.ldif\" to LDAP DB:
\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`

\# ldapadd -x -W -D \"cn=Manager,dc=spider,dc=com\" -y
\<\<PASSWORD_FILE/eg redhat\>\> -f /usr/share/migrationtools/users.ldif

\# ldapadd -x -W -D \"cn=Manager,dc=spider,dc=com\" -y
\<\<PASSWORD_FILE/eg redhat\>\> -f /usr/share/migrationtools/groups.ldif

-x : auth -W : Password based -D : Domain entries -y : Read password
from a file -f : new LDIF file

We can also check if we can fetch the users and groups details via LDAP:
\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`
\# ldapsearch -x cn=ldapuser1 -b dc=spider,dc=com

ALL DONE

Add ldap services in firewall:
\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\` \#
firewall-cmd \--zone=public \--add-service=ldap \--permanent \#
firewall-cmd \--reload

LDAP Client: \[ Without autofs home dir \]\[ CentOS-7 \]
\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`
yum install openldap-clients nss-pam-ldapd -y

yum install openldap-clients sssd sssd-ldap oddjob-mkhomedir -y \[
CentOS-9 \]

authconfig \--enableldap \--enableldapauth
\--ldapserver=ldap://master.spider.com
\--ldapbasedn=\"dc=spider,dc=com\" \--enablemkhomedir \--update

systemctl start nslcd.service

getent passwd ldapuser1 getent passwd ldapuser2 su - ldapuser1 su -
ldapuser2

LDAP Client: \[ Without autofs home dir \] \[ CentOS-9 \]
\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`\`
\# yum -y install openldap-clients sssd sssd-ldap oddjob-mkhomedir \#
authselect select sssd with-mkhomedir \--force

\# vim /etc/sssd/sssd.conf

\# replace \[ldap_uri\], \[ldap_search_base\] to your own environment
value \[domain/default\] id_provider = ldap autofs_provider = ldap
auth_provider = ldap chpass_provider = ldap ldap_uri =
ldap://master.spider.com/ ldap_search_base = dc=spider,dc=com
ldap_id_use_start_tls = False ldap_tls_cacertdir = /etc/openldap/certs
cache_credentials = True ldap_tls_reqcert = allow

\[sssd\] services = nss, pam, autofs domains = default

\[nss\] homedir_substring = /home

:wq

\# chmod 600 /etc/sssd/sssd.conf \# systemctl restart sssd oddjobd \#
systemctl enable sssd oddjobd

getent passwd ldapuser1 getent passwd ldapuser2 su - ldapuser1 su -
ldapuser2

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
